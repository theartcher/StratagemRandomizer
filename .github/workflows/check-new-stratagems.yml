name: Check for New Stratagems

on:
  push:
    branches:
      - icon-test
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-stratagems:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      # ── Step 1: Scrape wiki, merge data, and update icons ───────────────────
      - name: Check for new stratagems
        id: check
        run: |
          node scripts/check-new-stratagems.mjs

          # Read the output file
          NEW_COUNT=$(node -e "
            const data = require('./new-stratagems.json');
            console.log(data.new_stratagems.length);
          ")
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT

          if [ "$NEW_COUNT" -gt 0 ]; then
            echo "has_new=true" >> $GITHUB_OUTPUT
            NAMES=$(node -e "
              const data = require('./new-stratagems.json');
              console.log(data.new_stratagems.map(s => s.name).join(', '));
            ")
            echo "new_names=$NAMES" >> $GITHUB_OUTPUT
          else
            echo "has_new=false" >> $GITHUB_OUTPUT
          fi

      # ── Step 2: Create PR with changes ─────────────────────────────────────
      - name: Clean up temporary files
        if: steps.check.outputs.has_new == 'true'
        run: rm -f new-stratagems.json

      - name: Create Pull Request
        if: steps.check.outputs.has_new == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: Add new stratagem(s): ${{ steps.check.outputs.new_names }}"
          title: "feat: Add ${{ steps.check.outputs.new_count }} new stratagem(s)"
          body: |
            ## New Stratagem(s) Detected ⚡

            The automated wiki check found **${{ steps.check.outputs.new_count }}** new stratagem(s) on the [Helldivers Wiki](https://helldivers.wiki.gg/wiki/Stratagems):

            **${{ steps.check.outputs.new_names }}**

            ### Changes
            - Updated `data/stratagems.json` with new entries
            - Updated `data/warbonds.json` (if new warbonds were found)
            - Updated icons in `public/icons/` (if available in upstream icon repo)

            ### ⚠️ Manual Review Required
            Please verify the following before merging:
            - [ ] Stratagem `category` is correct
            - [ ] Stratagem `subcategory` is set properly (e.g. `backpack_weapon`, `mine`, `static`)
            - [ ] `requires_backpack` flag is correct for support weapons
            - [ ] Stratagem `code` (direction sequence) matches in-game input
            - [ ] Icons are present and correct in `public/icons/`
            - [ ] No duplicate entries were created

            ---
            *This PR was automatically generated by the [Check for New Stratagems](.github/workflows/check-new-stratagems.yml) workflow.*
          branch: automated/new-stratagems
          delete-branch: true
          labels: |
            automated
            new-content

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.has_new }}" == "true" ]; then
            echo "### ⚡ New Stratagems Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Found **${{ steps.check.outputs.new_count }}** new stratagem(s):" >> $GITHUB_STEP_SUMMARY
            echo "**${{ steps.check.outputs.new_names }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with the changes." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ✓ No New Stratagems" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Local data is up to date with the wiki." >> $GITHUB_STEP_SUMMARY
          fi
